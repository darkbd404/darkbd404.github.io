<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>৩০ দিনের মেডিসিন রুটিন — Settings + Safe Check</title>
<style>
  :root{
    --bg:#071226; --card:#0c1b2b; --muted:#9fb3c7; --accent:#34d399; --accent2:#60a5fa;
    --pill-shadow: 0 8px 28px rgba(2,6,23,0.6);
    --radius:12px;
  }
  *{box-sizing:border-box;font-family:'Noto Sans Bengali', system-ui,-apple-system,'Segoe UI',Roboto,Arial;}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#041226,#071833);color:#e6f3fb;}
  .app{max-width:1100px;margin:14px auto;padding:12px;}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#0ea5a0,#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:800;color:#00221b;font-size:20px;box-shadow:var(--pill-shadow)}
  h1{margin:0;font-size:18px}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .top-controls{display:flex;gap:8px;margin-top:8px;align-items:center;justify-content:space-between}
  .btn{background:var(--accent);border:none;color:#012;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:10px;color:var(--muted);cursor:pointer}

  .layout{display:block;gap:12px;margin-top:12px}
  @media(min-width:980px){ .layout{display:grid;grid-template-columns:360px 1fr;align-items:start;} }
  .panel{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02);box-shadow:var(--pill-shadow)}
  .med-list{display:flex;flex-direction:column;gap:10px}
  .med{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);cursor:pointer}
  .ico{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;font-size:16px}
  .ico.zinc{background:linear-gradient(135deg,#06b6d4,#3ddcf7)}
  .ico.omega{background:linear-gradient(135deg,#f59e0b,#ffb86b)}
  .ico.vitE{background:linear-gradient(135deg,#ef4444,#ff7a9a)}
  .ico.tad{background:linear-gradient(135deg,#7c3aed,#b794f4)}
  .med h4{margin:0;font-size:15px}
  .med p{margin:4px 0 0;color:var(--muted);font-size:13px}

  .calendar-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
  .calendar-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px}
  .day{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);transition:transform .18s;cursor:pointer;overflow:hidden}
  .day:hover{transform:translateY(-6px)}
  .day .head{display:flex;justify-content:space-between;align-items:center}
  .day .daynum{font-weight:800}
  .date{color:var(--muted);font-size:12px}
  .tasks{margin-top:8px;display:flex;flex-direction:column;gap:8px}
  .task{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
  .task label{display:flex;gap:8px;align-items:center}
  .task input[type=checkbox]{width:18px;height:18px;accent-color:var(--accent);cursor:pointer}
  .done{display:none;margin-top:8px;padding:8px;background:linear-gradient(90deg,#0ea5a0,#16a34a);color:#00221b;border-radius:8px;font-weight:700;text-align:center}

  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:99}
  .modal .box{width:720px;max-width:96%;background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .field{margin-bottom:10px}
  .field label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
  .field input[type="time"], .field input[type="text"], .field input[type="date"], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}

  .muted{color:var(--muted);font-size:13px}
  @media print {
    .modal, header, .top-controls, .icon-btn, .btn.secondary { display:none; }
    .report{display:block !important}
  }
</style>
</head>
<body data-theme="dark">
  <div class="app">
    <header>
      <div class="logo">৩৺</div>
      <div>
        <h1>৩০ দিনের মেডিসিন রুটিন — (Settings + Safe Check)</h1>
        <p class="lead">Zinc, Omega-3, Vitamin E, Intimate (Tadalafil) • Dhaka time</p>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="settingsBtn" class="icon-btn">⚙️ Settings</button>
        <button id="printToday" class="btn">Print Today</button>
      </div>
    </header>

    <div class="top-controls">
      <div style="display:flex;gap:10px;align-items:center">
        <div class="badge" id="todayLabel">Day 1 = আজ</div>
        <div class="muted" id="clock">--:--:-- Dhaka</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="downloadBackup" class="btn secondary">Export JSON</button>
        <input id="restoreFile" type="file" accept="application/json" style="display:inline-block">
      </div>
    </div>

    <div class="layout">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>4 Medicines (Details)</strong>
            <div class="muted">প্রতিটি ট্যাপ করলে ছোট বর্ণনা দেখাবে</div>
          </div>
        </div>

        <div style="margin-top:10px" class="med-list" id="medList"></div>

        <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(255,255,255,0.03)">

        <div>
          <strong>Quick actions</strong>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="markAllToday" class="btn secondary">Mark Today (যদি না খেয়ে থাকে)</button>
            <button id="exportAllCsv" class="btn secondary">Export All CSV</button>
          </div>
        </div>

      </div>

      <div class="panel">
        <div class="calendar-head">
          <div>
            <strong>30-Day Calendar</strong>
            <div class="muted small">টাস্ক চেক করলে রিপোর্ট অটোমেটিক খুলবে না — কার্ডে ক্লিক করলে রিপোর্ট খুলবে</div>
          </div>
          <div><label class="muted small">Start from: <span id="startDisplay">—</span></label></div>
        </div>

        <div class="calendar-grid" id="calendarGrid"></div>

        <div class="report" id="dailyReport">
          <div class="title" id="reportTitle">Daily Report</div>
          <div class="meta" id="reportMeta"></div>
          <table class="report-table" id="reportTable"></table>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="printReportBtn" class="btn">Print / Download PDF</button>
            <button id="exportReportCsv" class="btn secondary">Export CSV</button>
            <button id="closeReport" class="btn secondary">Close</button>
          </div>
        </div>

      </div>
    </div>

    <footer style="margin-top:12px;color:var(--muted);font-size:13px">LocalStorage এ ডাটা স্টোর হয় — ব্যাকআপ নিয়ে রাখুন।</footer>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modal" id="modal">
    <div class="box">
      <h3>Settings</h3>
      <div class="field">
        <label>Start date (Day 1)</label>
        <input id="startDate" type="date">
      </div>
      <div class="field">
        <label>Your name</label>
        <input id="userName" type="text" placeholder="আপনার নাম">
      </div>
      <div class="field">
        <label>Reminder times (Dhaka) — comma separated (HH:MM)</label>
        <input id="remTimes" type="text" placeholder="08:30,13:00">
      </div>
      <div class="field">
        <label>Theme</label>
        <select id="themeSelect">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="saveModal" class="btn">Save Settings</button>
        <button id="closeModal" class="btn secondary">Close</button>
      </div>
    </div>
  </div>

<script>
/* ---------- constants & storage ---------- */
const DAYS = 30;
const STORAGE_KEY = 'virya_4meds_v1';
const SETTINGS_KEY = 'virya_4meds_settings_v1';

const MEDICINES = [
  {id:'zinc', name:'Zinc 20 mg', short:'Sperm count & testosterone support', info:'Zinc helps raise sperm count and quality. Take with food.'},
  {id:'omega', name:'Omega-3 Fish Oil 1000 mg', short:'Sperm membrane & hormone support', info:'EPA/DHA support sperm motility and hormone balance. Take with meal.'},
  {id:'vitE', name:'E-CAP 400 (Vitamin-E)', short:'Antioxidant, protects sperm', info:'Protects sperm from oxidative damage; helps overall fertility.'},
  {id:'tadalafil', name:'Intimate 10 (Tadalafil)', short:'For erection — use only PRN', info:'PDE-5 inhibitor; use 30–60 min before sex. Not daily without doctor advice.'}
];

let state = loadState() || {};
let settings = loadSettings() || { startDate:null, userName:'', reminders:[], reminderEnabled:false, theme:'dark' };

/* ---------- Dhaka helpers ---------- */
function getDhakaParts(){ const fmt = new Intl.DateTimeFormat('en',{timeZone:'Asia/Dhaka',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}); const parts = fmt.formatToParts(new Date()); const obj={}; parts.forEach(p=>{ if(p.type!=='literal') obj[p.type]=p.value }); return { year:+obj.year, month:+obj.month, day:+obj.day, hour:+obj.hour, minute:+obj.minute, second:+obj.second }; }
function dhakaYMDFromDate(d){ return new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Dhaka',year:'numeric',month:'2-digit',day:'2-digit'}).format(d); }
function todayDhakaYMD(){ const p=getDhakaParts(); return `${p.year}-${String(p.month).padStart(2,'0')}-${String(p.day).padStart(2,'0')}`; }
function bn(n){ const bnDigits='০১২৩৪৫৬৭৮৯'; return String(n).split('').map(c=>/\d/.test(c)?bnDigits[c]:c).join(''); }
function bnDate(ymd){ const [y,m,d]=ymd.split('-').map(Number); const months=['জানুয়ারি','ফেবুয়ারি','মার্চ','এপ্রিল','মে','জুন','জুলাই','আগস্ট','সেপ্টেম্বর','অক্টোবর','নভেম্বর','ডিসেম্বর']; return `${bn(d)} ${months[m-1]}, ${bn(y)}`; }

/* ---------- storage wrappers ---------- */
function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }catch(e){ return {}; } }
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }catch(e){ return {}; } }
function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }

/* ---------- UI elements ---------- */
const medListEl = document.getElementById('medList');
const calendarGrid = document.getElementById('calendarGrid');
const startDisplay = document.getElementById('startDisplay');
const todayLabel = document.getElementById('todayLabel');
const clockEl = document.getElementById('clock');
const modal = document.getElementById('modal');
const startDateInput = document.getElementById('startDate');
const userNameInput = document.getElementById('userName');
const remTimesInput = document.getElementById('remTimes');
const themeSelect = document.getElementById('themeSelect');
const reportPanel = document.getElementById('dailyReport');
const reportTitle = document.getElementById('reportTitle');
const reportMeta = document.getElementById('reportMeta');
const reportTable = document.getElementById('reportTable');

/* ---------- build med list ---------- */
function buildMedList(){
  medListEl.innerHTML = '';
  MEDICINES.forEach(m=>{
    const el = document.createElement('div'); el.className='med';
    const ico = m.id==='zinc'?'zinc': m.id==='omega'?'omega': m.id==='vitE'?'vitE':'tad';
    el.innerHTML = `<div class="ico ${ico}">${m.name.split(' ')[0]}</div><div><h4>${m.name}</h4><p>${m.short}</p></div>`;
    el.addEventListener('click', ()=> alert(`${m.name}\n\n${m.info}`));
    medListEl.appendChild(el);
  });
}

/* ---------- build calendar ---------- */
function buildCalendar(){
  calendarGrid.innerHTML = '';
  const start = settings.startDate ? new Date(settings.startDate + 'T00:00:00') : new Date();
  startDisplay.textContent = settings.startDate ? bnDate(settings.startDate) : 'আজ';
  todayLabel.textContent = `Day 1 = ${bnDate(dhakaYMDFromDate(start))}`;
  for(let i=0;i<DAYS;i++){
    const d = new Date(start.getTime()); d.setDate(start.getDate()+i);
    const ymd = dhakaYMDFromDate(d);
    const dayNum = i+1;
    const card = document.createElement('div'); card.className='day'; card.dataset.ymd = ymd;
    const tasks = state[ymd] || {};
    const requiredIds = ['zinc','omega','vitE'];
    const allTaken = requiredIds.every(id => tasks[id]);
    const isPast = (ymd < todayDhakaYMD());
    let tasksHtml = MEDICINES.map(m=>{
      const checked = tasks[m.id] ? 'checked' : '';
      const disabled = isPast ? 'disabled' : '';
      const label = (m.id==='tadalafil') ? `${m.name} (optional)` : `${m.name}`;
      return `<div class="task"><label><input type="checkbox" data-date="${ymd}" data-task="${m.id}" ${checked} ${disabled}/> <div style="font-weight:700">${label}</div></label><div class="muted">${tasks[m.id] ? 'গ্রহণ করা হয়েছে' : 'না'}</div></div>`;
    }).join('');
    card.innerHTML = `<div class="head"><div><div class="daynum">দিন ${bn(dayNum)}</div><div class="date">${bnDate(ymd)}</div></div><div class="muted small">${ymd===todayDhakaYMD()?'আজ':''}</div></div><div class="tasks">${tasksHtml}</div><div class="done" style="${allTaken ? 'display:block':'display:none'}">ওষুধ খাওয়া শেষ ✅</div>`;
    // card click opens report
    card.addEventListener('click', (e)=> {
      // if the click came from a checkbox, we prevent here by relying on stopPropagation on checkbox click
      openDailyReport(ymd);
      document.querySelectorAll('.day').forEach(dd=>dd.classList.remove('selected'));
      card.classList.add('selected');
    });
    calendarGrid.appendChild(card);
  }
  // attach handlers after rendering
  attachCheckboxHandlers();
}

/* ---------- checkbox handlers (NO report on check) ---------- */
function attachCheckboxHandlers(){
  document.querySelectorAll('.task input[type="checkbox"]').forEach(chk=>{
    // prevent checkbox click from bubbling to card (so card click won't fire)
    chk.addEventListener('click', (e)=> {
      e.stopPropagation();
    });
    chk.addEventListener('change', (e)=>{
      const date = chk.dataset.date, task = chk.dataset.task;
      if(!state[date]) state[date] = {};
      state[date][task] = chk.checked;
      saveState();
      // only update UI, do NOT open report
      buildCalendar();
    });
  });
}

/* ---------- Daily report ---------- */
function openDailyReport(ymd){
  const day = state[ymd] || {};
  reportPanel.classList.add('active');
  reportTitle.textContent = `Daily Report — ${bnDate(ymd)}`;
  reportMeta.textContent = `User: ${settings.userName || '—'} • Date: ${ymd}`;
  reportTable.innerHTML = '';
  MEDICINES.forEach(m=>{
    const tr = document.createElement('tr');
    const taken = day[m.id] ? 'Yes' : 'No';
    tr.innerHTML = `<td style="width:70%"><strong>${m.name}</strong><div class="muted small">${m.short}</div></td><td style="width:30%">${taken}</td>`;
    reportTable.appendChild(tr);
  });
  reportPanel.scrollIntoView({behavior:'smooth', block:'center'});
}
document.getElementById('closeReport').addEventListener('click', ()=> { reportPanel.classList.remove('active'); document.querySelectorAll('.day').forEach(dd=>dd.classList.remove('selected')); });
document.getElementById('printReportBtn').addEventListener('click', ()=>{
  const sel = document.querySelector('.day.selected'); const ymd = sel ? sel.dataset.ymd : todayDhakaYMD(); printDailyReport(ymd);
});
function printDailyReport(ymd){
  const day = state[ymd] || {};
  const title = `Daily Report — ${bnDate(ymd)}`;
  let html = `<!doctype html><html><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;padding:18px;color:#041226}h1{font-size:20px}table{width:100%;border-collapse:collapse}td{padding:8px;border-bottom:1px solid #eee}.taken{color:green;font-weight:700}.not{color:#999}</style></head><body>`;
  html += `<h1>${title}</h1><div style="color:#666;margin-bottom:8px">User: ${settings.userName || '—'} • Date: ${ymd}</div><table>`;
  MEDICINES.forEach(m=>{
    const taken = day[m.id] ? '<span class="taken">Yes</span>' : '<span class="not">No</span>';
    html += `<tr><td style="width:70%"><strong>${m.name}</strong><div style="color:#666;font-size:13px">${m.short}</div></td><td style="width:30%">${taken}</td></tr>`;
  });
  html += `</table><div style="margin-top:12px;color:#666;font-size:13px">Generated: ${new Date().toLocaleString()}</div></body></html>`;
  const w = window.open('', '_blank'); w.document.write(html); w.document.close(); setTimeout(()=> w.print(), 600);
}

/* ---------- export / backup ---------- */
document.getElementById('downloadBackup').addEventListener('click', ()=>{
  const payload = {state, settings, generatedAt:new Date().toISOString()};
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='virya_4meds_backup.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('restoreFile').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=function(){ try{ const obj=JSON.parse(r.result); if(obj.state && obj.settings){ if(confirm('Import will overwrite current data. Continue?')){ state=obj.state; settings=obj.settings; saveState(); saveSettings(); buildAll(); alert('Import OK'); } } else alert('Invalid JSON'); }catch(err){ alert('Invalid file') } }; r.readAsText(f); });

/* ---------- settings modal logic ---------- */
document.getElementById('settingsBtn').addEventListener('click', ()=> {
  // open modal and populate fields
  startDateInput.value = settings.startDate || '';
  userNameInput.value = settings.userName || '';
  remTimesInput.value = (settings.reminders || []).join(',');
  themeSelect.value = settings.theme || 'dark';
  modal.style.display = 'flex';
});
document.getElementById('closeModal').addEventListener('click', ()=> modal.style.display = 'none');
document.getElementById('saveModal').addEventListener('click', ()=>{
  settings.startDate = startDateInput.value || null;
  settings.userName = userNameInput.value.trim() || '';
  const rStr = remTimesInput.value.trim();
  settings.reminders = rStr ? rStr.split(',').map(s=>s.trim()).filter(Boolean) : [];
  settings.reminderEnabled = (settings.reminders.length>0);
  settings.theme = themeSelect.value || 'dark';
  saveSettings(); saveState(); modal.style.display = 'none'; buildAll(); scheduleReminders();
  alert('Settings saved');
});

/* ---------- mark all today ---------- */
document.getElementById('markAllToday').addEventListener('click', ()=>{
  const ymd = todayDhakaYMD();
  if(!state[ymd]) state[ymd] = {};
  ['zinc','omega','vitE'].forEach(id => state[ymd][id] = true);
  saveState(); buildAll();
});

/* ---------- reminders (simple) ---------- */
let reminderInterval = null;
async function requestNotificationPermission(){ if(!('Notification' in window)) return false; const p = await Notification.requestPermission(); return p === 'granted'; }
function scheduleReminders(){ if(reminderInterval) clearInterval(reminderInterval); if(!settings.reminderEnabled || !settings.reminders || settings.reminders.length===0) return; reminderInterval = setInterval(()=>{ const p=getDhakaParts(); const hh=String(p.hour).padStart(2,'0'), mm=String(p.minute).padStart(2,'0'); const now=`${hh}:${mm}`; if(settings.reminders.includes(now)){ if(Notification.permission !== 'granted') requestNotificationPermission().then(ok=>{ if(ok) new Notification('Medicine Reminder', {body:`সময়: ${now}`}); }); else new Notification('Medicine Reminder', {body:`সময়: ${now}`}); try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.04; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>o.stop(),200); }catch(e){} } },15000); }

/* ---------- build all & init ---------- */
function buildAll(){ buildMedList(); buildCalendar(); loadSettingsToUI(); }
function loadSettingsToUI(){ document.getElementById('startDate').value = settings.startDate || ''; document.getElementById('userName').value = settings.userName || ''; document.getElementById('remTimes').value = (settings.reminders || []).join(','); document.body.setAttribute('data-theme', settings.theme || 'dark'); }
function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }catch(e){ return {}; } }
function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }catch(e){ return {}; } }

function updateClock(){ const p=getDhakaParts(); clockEl.textContent = `${bn(p.hour)}:${bn(p.minute)}:${bn(p.second)} Dhaka`; }
setInterval(updateClock,1000); updateClock();

function init(){ state = loadState() || {}; settings = loadSettings() || settings; if(!settings.theme) settings.theme='dark'; document.body.setAttribute('data-theme', settings.theme); buildAll(); if(settings.reminderEnabled) scheduleReminders(); scheduleMidnightRefresh(); }
init();

function scheduleMidnightRefresh(){ const p=getDhakaParts(); const dhakaOffset=6*3600*1000; const nextMidUtc = Date.UTC(p.year,p.month-1,p.day+1,0,0,0) - dhakaOffset; const ms = nextMidUtc - Date.now(); const delay = (ms>0 && ms < 7*24*3600*1000) ? ms : 60000; setTimeout(()=>{ buildAll(); scheduleMidnightRefresh(); }, delay+1200); }

/* ---------- utility: print today's report ---------- */
document.getElementById('printToday').addEventListener('click', ()=>{ const ymd = todayDhakaYMD(); openDailyReport(ymd); setTimeout(()=> printDailyReport(ymd), 400); });
document.getElementById('exportAllCsv').addEventListener('click', ()=> exportAllCsv());
function exportAllCsv(){ const rows=[['date','medicine','taken']]; const start = settings.startDate ? new Date(settings.startDate+'T00:00:00') : new Date(); for(let i=0;i<DAYS;i++){ const d=new Date(start.getTime()); d.setDate(start.getDate()+i); const ymd = dhakaYMDFromDate(d); const day = state[ymd] || {}; MEDICINES.forEach(m=> rows.push([ymd, m.name, !!day[m.id]])); } const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n'); const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='virya_all.csv'; a.click(); URL.revokeObjectURL(url); }

/* ---------- helper exposure ---------- */
window.virya = { state, settings, saveState, saveSettings, buildAll };

</script>
</body>
</html>